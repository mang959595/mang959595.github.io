---
title: 邮件服务实现思路
date: 2024-01-05 10:22:29
tags: 邮件服务
categories: 
- 游戏开发
- 服务端
---



## Mail Server

- 管理玩家的邮箱数据，包括从数据库（数据库代理服务器）加载、修改并保存到数据库
  - 与数据库代理的交互，会有监控机制监控操作是否成功，若不成功则会进行重试
  - 重试次数会有上限，或者限流，防止压垮数据库
- 向GS请求验证玩家是否满足接受邮件的条件
- 向GS请求验证玩家是否满足领取附件的条件
- 向GS通知玩家领取附件
- 与客户端直接进行交互（由GS转发）
  - 客户端视角：
    - 获取所有邮件
    - 设置已读
    - 删除邮件
    - 领取附件
  - Mail Server 视角：
    - 同步邮箱
    - 同步新邮件
    - 数据增删查改
    - 邮件过期通知



## Game Server

- 注册到 Mail Server 后，Mail Server 同步过来该服（所在group）的所有邮件
- 验证玩家是否符合接收邮件的条件，并将符合的邮件及其对应的玩家告知 Mail Server，Mail Server更新邮件数据
- 验证玩家是否符合接受附件的条件，符合则在GS这边更新玩家的附件内容，并告知 Mail Server 附件条件符合的玩家情况，Mail Server 更新玩家邮件附件领取状态
- GS发送广播邮件过程
  - GS 先向 Mail Server 通知要发送广播邮件
  - Mail Server 更新 GS 的广播邮件数据，并发给 GS 验证广播邮件的请求
  - GS 分帧验证符合接收邮件条件的在线玩家，并将符合情况发给 Mail Server
  - Mail Server 更新各个在线玩家的邮件数据，并给对应的在线玩家发送该广播邮件（由GS转发）
- GS发送单播邮件过程
  - GS 先向 Mail Server 通知要发送单播邮件给某个玩家
  - Mail Server 更新玩家数据，并给对应玩家发送该广播邮件（由GS转发）



## 其他

### GS广播邮件时不在线的玩家，在其上线后如何收到邮件

- 首先，Mail Server 记录有每个玩家已接收的最新邮件序号，记录有 GS（所在group）上的所有邮件
- 可以推测，每当 Mail Server 向 GS 请求验证完玩家收取邮件的条件后，若玩家能够接收邮件，Mail Server 会更新其收到的最新邮件序号
- 于是，不在线的玩家的最新邮件序号可能是过时的，当玩家登陆时，Mail Server 要向GS请求验证该玩家的邮件接收
- GS 的做法是，从玩家的最新邮件序号开始，遍历自己同步到的邮件列表，验证每一个序号大于玩家当前最新邮件序号的邮件，并将符合的邮件的序号加入到回包中，发回给 Mail Server
- Mail Server 根据验证情况，更新玩家的邮件数据和最新邮件序号



### 客户端的视角

- 客户端登陆后，Mail Server 会收到玩家上线通知，并加载玩家的邮箱数据
- Mail Server 加载完成后，通知客户端加载完成（但不立即同步邮箱数据）
- 客户端通过 UI 交互触发同步邮箱数据请求，Mail Server 发送邮箱同步数据
- 客户端之后可以通过检查邮箱数据请求，与 Mail Server 校对邮箱数据是否是最新的（通过最新邮件序号）
  - 不是最新的的话，Mail Server 需要发送同步数据给客户都
- 客户端可以进行邮件的读取、删除、领取附件的请求
- 客户端在线时，若有新的邮件，Mail Server 会发送单个邮件同步数据过来



### Mail Server 的性能考虑

- 数据结构：邮件数据以有序的形式组织
- 用户量：只有当玩家上线或者需要给玩家发送邮件时，才从数据库中加载玩家的邮箱数据
- 过期处理：仅对在线玩家做实时的过期判断
- 每帧限制处理数量，防止卡帧丢帧







